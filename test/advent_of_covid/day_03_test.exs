defmodule AdventOfCovid.Day03Test do
  use ExUnit.Case

  alias AdventOfCovid.Day03
  alias AdventOfCovid.Day03.WorldMap

  @example_input """
  ..##.......
  #...#...#..
  .#....#..#.
  ..#.#...#.#
  .#...##..#.
  ..#.##.....
  .#.#.#....#
  .#........#
  #.##...#...
  #...##....#
  .#..#...#.#
  """

  @provided_input """
  .....#....#...#.#..........#...
  ...#.................#.........
  ......#...#.#.#.....#..#.....#.
  .........#.#.............##....
  #..####..#..#.##.....#.........
  ...#........#..##...........#..
  ..##.#.#..#....#..#......#.#...
  .......#.##....#.....###....#.#
  .#..#...#......#..#....##.#....
  ...#...............#.#.....#...
  ..#............#..#.........#.#
  #.#.#.............##.#......#..
  #...#..............##...#.#....
  ...#....#................#.#..#
  ..#.#..#.#.#..#.....#.........#
  #.............#..#..........#..
  .#...#.#........###.#....#...#.
  #......#....#.#..#.##..#.......
  .##......###.#......#..##...#..
  #..#....#........#......#.#....
  .#..................#.....#.###
  .#......#.#.#.....#...#.#......
  ....#.............#.#..........
  ....#..#.#........#..###.......
  .....#....#...#........#.......
  ...........#.###....##.......#.
  ....#...........#.#..#...#.....
  ...........#.....#.#...........
  .....#........#.....#.#..#....#
  #.#......#.......#.......#.....
  ..........#.............#.#.#..
  #...#..........#....#....#.....
  .#.#......#..##...#.....#...##.
  .#....#...#.#.......#.#........
  ....#....##.##...#.............
  #...#....#..#.........#........
  ...#.....#.#...#.......#..#....
  #.......#...#....##........#..#
  ####........#........#....#.#..
  ............##..........#......
  .......#.....#.#.#.##..#...#...
  ..........#....#...##.........#
  ..##..####.......##......#.##..
  .....#.#......##...#..#...#....
  ....#.#.#.........#........#...
  ...........###...#.........##..
  .......#.#....#......#.##...##.
  .................#...##.#...##.
  .......#.......#..#.#..........
  .#....#..#....#........#.......
  ...............#.##..#...##..#.
  .###.#....#......#...#.#.....#.
  .#.....##.......#.......#......
  ....#..#.....#.....#...........
  .......#....#.................#
  .......#.##...#...#......#.....
  .#.....#...####.............#..
  ......#.........#..........#...
  .........#....#....#........###
  ....#.........#......##.....#..
  ....#........##...##.....##...#
  .#..#....#..........#...#.###.#
  #..#......#...#........#.......
  ...#.........................#.
  .............#........#........
  .......#.#.#.....##.....#..#...
  ..##..##.........#.............
  .#...#..#......#...##..##..###.
  .....#....#...#...##.##........
  .#.#..#...........#..#..#......
  ##..#...#..#...##..#....#......
  ...#...#...#.........#....###..
  ...##..#....#.#.#.......#...#..
  ..#.#.....#..#....#..##.......#
  .....#.#.....#......#....#.#...
  .......##....#.....#...#.....#.
  ..##..#.................#.#....
  ..............##....##.#..##...
  .#..#.....#....#.#.#...........
  ......#.#.#..#..#...#.....#..##
  ..#.........#.#.......###...##.
  #.....#...........#.....#.##.#.
  #..........#....#....#..#....#.
  .#.....#...#.......###......#..
  ....##..##......#....#....#....
  .......#.#.............#....#.#
  .#..#.##.##.##....#.#.....##.##
  ....#..##.#..#.............##..
  ....#...........#...#....#..#..
  ...........#..#....#....##.#.##
  ......#....#....#.....#......#.
  .##.##....#.....#.#......#...#.
  .....##.......#.#.#........##..
  #..........##..#....#..#.#....#
  ...#...........................
  ...#..#...#..#.#.#.#.......#.#.
  .....#.........#..###..........
  ...#.#......##....#......#..###
  #..............#....#.......#..
  .........##......###..###......
  ..#......##...........#.##.....
  #.#..#......#...##.............
  ......#.#.............#....#..#
  #.....##..#.#.................#
  ..##....#.....#....#.....###...
  .#.#.##.....#..................
  .#......#.#.#.....#..#....#....
  ..#.#.....##.#...#..#.#.##.....
  ..#.#..#......##.#.#..........#
  .......##.....#..#...#....##.#.
  ...#.....#..........#..........
  ......................##......#
  ...###.........##.........#....
  ....#..................#.....#.
  .##..#.............#........##.
  ....#....#...###..........#....
  .....#.#..........###..........
  ..#......##......#.#.##.#..#...
  ##...........#.#..#.....#..#...
  .........#......#..........#.#.
  ...#.##.#..#..###..#...........
  ....##.#.##...........#.....##.
  ....#...................###....
  #.......#......#......#.....#..
  #..........##..................
  ...#..#.#....#..#.........##.#.
  ......#...##.#...............#.
  .........#....#.#...#..#..#....
  ...#......###..#......#.....#.#
  #..###.#.............#.........
  ......#...........#............
  ..#..#.##.....#......#.#..#...#
  .........#..............#......
  ........#.....#..#...#.....#..#
  .....................#........#
  .##.......##...#.###.........#.
  .#...#.......#.#....##....#....
  ........#......#...........#.#.
  ....#......##...#.....#...#...#
  ..#.........#.#...............#
  ....#.....#......#.............
  .............##.....#....#.....
  ........#......#.#.....#....#..
  #.........#...#......#....#...#
  .#........###...#.#.#...#....#.
  .###...........#..#............
  ....##.........#..#...##.#..###
  .####..#.#...............##.#..
  #.....#...#....#.......##....#.
  ..#.....##...##.#...#..#.......
  ..#.###.......#.....#.......#..
  ...........#.......#....##....#
  ..#...#....##........###......#
  ...#..#..............#...#.....
  ##.#.............#....##.#..##.
  ##.#..#..............#.#.......
  .......#....#....##............
  .##..##.#..........#.#...#.#...
  .........##.......##...#...#...
  ............#...##....#...#....
  ........#...#..#...#.##......#.
  ..#...#.#.........#.#....#.....
  ..#...#.#..#.......#.#.........
  .......#.....#...#.#..###....#.
  .#......#.#....#.#.####....#...
  .......##..#......#...#......##
  #####.....#........#.#.......#.
  .....#...#..#...#.#.....#..#...
  ....#...#....##.....##....#.#..
  .#..#......#.####.....#....#..#
  ...#.......#..#.....##........#
  .#.....#.#.#.....##...#..#.....
  .............#...#..#.....#....
  ...#.....##.......#...##..#...#
  ..#.............#...#..#..##...
  ...#........#........#...#...#.
  ##..........#.#.#.............#
  ....#....#..............#..#...
  ....#..####..##....#.......#.#.
  .#..#.....##....#.#.....#...#..
  #............##..#..#.#......#.
  ....#..........##..#...........
  ..#.##.#.......#...#.##....#...
  ....#.#.............#.#.##....#
  ...#..#.#.#......#..#....#....#
  .............#...........#..#..
  #.............##.......#..###..
  ..##....#.#.#...#...#....#...#.
  ##.......####........##..#.....
  .###..#..#..#..#...#.#.........
  ............#............#.....
  #...#.....#.#.##.##...#.......#
  #........#....#...#.........#..
  #....#.#......#.............#..
  ....#............#......##...#.
  .......#........#..#.......#..#
  #.#...#.#.#..#..#........#....#
  #.#.##...........#.....#.....#.
  .#...##.#..#...................
  ###...#.#.....................#
  .#....##...##.#....#..#........
  ........###...#.#....##...#..##
  ...#..#..........###..#.......#
  ..#..##.............#.....#....
  ....##..#..............#.......
  ...##...##.#....#.#...#...#.#.#
  ..#..........#.....##........#.
  .#.#.....#......#..#....#......
  ...##.#....#.......#......#....
  ...##..#........##......#..##..
  #..###...#...........#.#.......
  ..##...#...#.#.#...#.#.....#...
  ..#.....##.#....#.....#..#.....
  ..#.#......#.......#...........
  ....##......##.............#..#
  .......#.........##...#..#...#.
  .#........#.##.#.....#.#.......
  #..#...#..#.....##...........#.
  ..##..............#....#.......
  .#..#....#.#...........#..##.#.
  #....#..###..........#...#.....
  .......#...##........#.#...###.
  ....#..#......##......#.....#..
  .#..##..#..#......#......#.##..
  ....#.#...........#..#.#.##.#..
  .....#......#.....#.....#..#...
  ..........#...........#...##...
  #..#.#.#..#....#.....##......##
  ..#.....#.....#................
  ...#.#..##.........#..#..##....
  .#.....##..#.#.#.#.....#.......
  ...........##...#..............
  ...#.#....##..#.............###
  ...#.#...........#.........#...
  #.....#.....##..#.#.#.#....#...
  ##..................##.##......
  ......#.....#....#.....#..#...#
  .............#.......#....#..##
  .#..#.##..#..#.........##...#..
  ..#.#....#........#....#....##.
  .#.#.#.#.#.......#.......#..#..
  #.....#..##..#.........#.......
  .............#.#..............#
  .........#......#....#.#......#
  .........#.#...##..#.#.........
  ...........#..........#........
  .......#...#...#......#..#.....
  #.....#...............#.....#.#
  ..#....#..........#.#...#..#...
  #....##..#..#.....#.#..#.#.....
  .#....#..###............##.....
  ......#.##...........#....#..#.
  ...#........##....#...#...#....
  ..#.#.#.....#..#.#..........##.
  ..................#...........#
  ##........#.#......#.#.......#.
  ......#..#.............##......
  .#..###..#...###......#....#..#
  ..#...........#...#...##..#...#
  ..#..........#..............#..
  .....#.........................
  ..#.#..##...........##...#.....
  ...........#......##.....##....
  ......#.......#................
  .........#.......#.#...........
  #......#...#........##.....##..
  ...#.....#....#..#.....#.......
  ....#.#......#...#..#.##.##...#
  ..#..#.#.....#...#...........#.
  .#....##.####.....#..........##
  ...##.##.....##..###...#.......
  .......#.#...#....#.......#..#.
  .#..#.###.#.............#......
  .###.........####..#...........
  #..#.#.###.....#.......#.......
  .#.....#.....#.....#.........#.
  ..#...#......#.......##.###....
  .......##.............##.#.....
  .....................#.....##.#
  ##.#...#........#..##........#.
  ...#..........#.#.#..#......###
  .#....#.#.#..........##........
  ....#....####....#.#....#..#.#.
  ..#.........#....##..........##
  ...##.#.......##.#.......#.#...
  ........#..#......#...#.#.....#
  .....##............#.#.......#.
  .........##...##..#.....#..#...
  #...#....#........#...#....##.#
  ..#.....#..........#...##.....#
  .##..#.........#...........#...
  .....##.#.#.#.#..#...#.....#.#.
  .#..#..##.........#.......#...#
  #....#.....#...#....#.........#
  ...#..#.......#.........#......
  .#....##..#......##.#.#......#.
  ....##.##...........#...#......
  ..#.#....#.##...#......#.......
  ...#........#.............#....
  ...##....................#.###.
  .#.......#.........#......##...
  ....#..#..............#....#...
  ....##.#............#..........
  .#...#....#...##..........#....
  ....#............#.....#.......
  .......#........#..............
  ....#.#....#.#..#..#...........
  ......................#.#......
  #......##.....#..#.......##....
  ...#........#........#.#...##..
  ##.#....##....#................
  #..#....#..............#.##....
  ......#........#...........#...
  #....##.##...#...#..#...##.....
  ............#............#..#..
  #....#...#..#..#.#...........#.
  .......#..........#..........##
  .....#......#....##.#..........
  .#....#....#....#....#..#...#..
  .....###....#...#.#.#........#.
  .......#...#..........##..#...#
  ..##........................##.
  .....#....#..............#....#
  """

  test "parses input" do
    assert %WorldMap{
             cols: 11,
             map: [
               [".", ".", "#", "#", ".", ".", ".", ".", ".", ".", "."],
               ["#", ".", ".", ".", "#", ".", ".", ".", "#", ".", "."],
               [".", "#", ".", ".", ".", ".", "#", ".", ".", "#", "."],
               [".", ".", "#", ".", "#", ".", ".", ".", "#", ".", "#"],
               [".", "#", ".", ".", ".", "#", "#", ".", ".", "#", "."],
               [".", ".", "#", ".", "#", "#", ".", ".", ".", ".", "."],
               [".", "#", ".", "#", ".", "#", ".", ".", ".", ".", "#"],
               [".", "#", ".", ".", ".", ".", ".", ".", ".", ".", "#"],
               ["#", ".", "#", "#", ".", ".", ".", "#", ".", ".", "."],
               ["#", ".", ".", ".", "#", "#", ".", ".", ".", ".", "#"],
               [".", "#", ".", ".", "#", ".", ".", ".", "#", ".", "#"]
             ],
             rows: 11
           } == Day03.parse_input(@example_input)
  end

  test "world map" do
    map = WorldMap.new([[0, 1], [2, 3]])

    # concrete coordinates
    assert WorldMap.at(map, 0, 0) == 0
    assert WorldMap.at(map, 0, 1) == 1
    assert WorldMap.at(map, 1, 0) == 2
    assert WorldMap.at(map, 1, 1) == 3

    # extending past edge
    assert WorldMap.at(map, 0, 2) == 0
    assert WorldMap.at(map, 0, 3) == 1
    assert WorldMap.at(map, 0, 4) == 0
    assert WorldMap.at(map, 0, 5) == 1
    assert WorldMap.at(map, 1, 2) == 2
    assert WorldMap.at(map, 1, 3) == 3
  end

  test "count trees example 1" do
    assert 7 ==
             @example_input
             |> Day03.parse_input()
             |> Day03.count_trees_to_bottom(1, 3)
  end

  test "count trees example 2" do
    map = Day03.parse_input(@example_input)

    assert Day03.count_trees_to_bottom(map, 1, 1) == 2
    assert Day03.count_trees_to_bottom(map, 1, 3) == 7
    assert Day03.count_trees_to_bottom(map, 1, 5) == 3
    assert Day03.count_trees_to_bottom(map, 1, 7) == 4
    assert Day03.count_trees_to_bottom(map, 2, 1) == 2
  end

  test "count trees part 1" do
    assert 299 ==
             @provided_input
             |> Day03.parse_input()
             |> Day03.count_trees_to_bottom(1, 3)
  end

  test "count trees part 2" do
    map = Day03.parse_input(@provided_input)

    assert 3_621_285_278 ==
             Day03.count_trees_to_bottom(map, 1, 1) *
               Day03.count_trees_to_bottom(map, 1, 3) *
               Day03.count_trees_to_bottom(map, 1, 5) *
               Day03.count_trees_to_bottom(map, 1, 7) *
               Day03.count_trees_to_bottom(map, 2, 1)
  end
end
